# Rustで作るゲームボーイエミュレータ

一度はやってみたいと思っていたエミュレータ作成が一段落し、ある程度形になったので、ゲームボーイの仕様解説であったり、感想であったりといった諸々のことを記事として残しておこうと思います。

純粋な作業期間としてはGitのログを見る限り一ヶ月半から二ヶ月といったところでしょうか。SoundとWASM対応まで含むと三ヶ月かかっているかと思います。ただ途中挫折しかけて二ヶ月から三ヶ月放置したりといったこともあり、first commitからは半年ほど経っていました。　

何故今ゲームボーイのエミュレータなどを作ろうと思ったかについてですが、案外多くの人がゲームボーイのエミュレータ実装をしているのを見て、自分でもやってみたいと思ったのがきっかけです。自作OSや自作言語ほど重くなく、それでいて軽すぎもせず、何より作っていて楽しそうだと考えました。作ったところで何かの役に立つわけではありませんが、技術者にとってのある種の「教養」と言えるのではないかと思います。

Rustを採用したのはもう少し即物的な理由で、確かに現状業務では使う機会が訪れないものの、今後を見据えるとある程度習熟しておいた方が良いだろうという考えがあったためです。習熟出来たか？と言われると苦笑せざるを得ませんが、まあ最初はこんなものでしょう。

ということで作ってみた感想ですが、CPUの実装など面倒な作業も含めて楽しかったです。

アルゴリズム的に高度なことや複雑な実装はほぼ要求されませんでした。ネットに転がっている資料を眺めて仕様を把握し、「何をどう実装すればいいのか」を認識する作業が本質だったと思います。実装よりも調査段階で挫折する人の方が多いのではないでしょうか。

作り始めた時はただでさえ実装すべきことが分からないのに、Rustのコンパイラにも怒られまくって脳の負担が大変なことになっていました。競プロのマラソンコンテストとかで事前に慣らしておくべきでしたね。

そして手を焼いたのはやはりデバッグでしょうか。有志によって数多くのテスト用ROMが公開されているのでバグの発見自体は容易です。この辺りゲームボーイエミュレータが初心者向けと言われる所以かなと。

ただ具体的なバグの理由と修正については地道な標準出力デバッグが基本になります。ステップ実行やブレークポイント機能を実装し、コケた位置を把握して、バイナリを逆アセンブルしたROMのソースコードと突き合わせたり、正しい動作をするエミュレータを引っ張ってきて出力を確かめる……といった作業が主になります。まあこの辺の作業はある程度経験のあるプログラマなら泣きながら何度もこなしてきたことかと思います。感覚としては、競プロで何故か一つだけWAが取れずに怒りのprintfデバッグをしている時と同じですね。
エミュレータの実行中、ワンボタンでデバッグモードに入れるようにしたり、RAMやVRAMをダンプ出来るようにしておくと捗ります。
特定の状況で起こるバグの場合、ステップ実行モードでその状況を引き起こすところまで進めるのは難しいので……。

とはいえそれなりの苦労があるからこそ、動いたときの感動は素晴らしいものでした。エミュレータはその性質上、読み込ませるROMによって多彩な様相を見せてくれます。マリオのように単純な横スクロールアクションからポケモンのような大ボリュームのRPGまで、自分が数ヶ月書いた程度のコードの上で動いてしまうわけなのですが、何だか自分が実際以上に凄いことをしたような気分になります（ROMの開発者は偉大ですね）。

決して初心者でも簡単に作れるとは言いませんが、興味のある方は是非挑戦してみてはいかがでしょうか。

別記事にて簡単な解説を書くので、作りたいという方はそちらも見ていただければと思います。

以下はgitのログを見たりしながら当時を回想したものです。どんな流れで開発が進んだか、どのくらいの期間挫折していたのかがわかると思います。

## 歴史

### 2/26

作ることを思い立ち `cargo new` する。  
とりあえず何をすれば良いのか調べ始める。

### 3/1

README.mdを書く。書いただけ。

### 3/8

ROM読み出しとMBC(NoMBC)を書く。マジでゆるゆるやってんな。

### 3/9

メモリアクセスのためのbusを書く。パターンマッチと相性が良く感動した記憶がある。  
ログには残ってないけど、チマチマとCPUを実装し始めたような気がする。多分。

### 4/9

いきなり一ヶ月空いて草。多分CPUの実装を調べていて気が遠くなったんだと思う。  
とはいえこの時点でコピペ祭りとはいえ2700行くらい書いているし、作って投げてを繰り返してたっぽい。

ここからちょっと気合を入れる。

### 4/12

ひとまずCPUの実装が終わる。頑張ってんな。

### 4/13

PPUの実装を始める。まずRustでGUIの実装ってどうやるの？というところから調べる。

### 4/14

色々調べてwinitとPixelsというライブラリを使うことに決める。  
サンプルをとりあえず実装して描画されることを確認する。

### 4/15

デバッグのためにステップ実行と標準出力機能を実装する。

### 4/26

Q. おっどうした？(疑問)  
A. PPUについて調べたものの、何をどうしたら良いのかわかんなくなっちゃった

とりあえずレジスタのread/writeと細かなバグ修正をする。

### 5/19

（´・ω・｀) < うん、「また」なんだ。済まない。

何をしたら良いのか分からなくなりながら、とりあえずテストROMを動かすため背景描画を書く。  
PPUをCPUに接続し、バグを潰してテストROMを動かしてみるが当然動かずしょんぼり。一時放り投げる。

### 7/7

（´・ω・｀) < 仏の顔もって言うしね、謝って許してもらおうとも思っていない。

いやでも復帰しただけ偉いだろ。

改めてドキュメントを読み直し、テストROMのアセンブラを読んだ。  
結果、PPUとCPUは同期させつつも並列で動かす必要があることを知る。そういうのが知りたかったんだよ。

というわけでPPUのtick(スキャンライン・描画モード等の概念)を実装し始める。

### 7/11

PPUのtickの実装が終わる。  
テストROMが動かず泣きながらstep実行していると、ジャンプ命令に複数のバグが見つかったので直す。

### 7/12

PPUのタイル番号指定のコードにバグがあることに気づき、それを潰すとテストROMが動作した。

本当に嬉しくて、一気にモチベーションが上がった。ここから開発速度が劇的に上がる。

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">うお〜Rustでのゲームボーイエミュレータの一番簡単なテストROMが動いたのじゃ <a href="https://t.co/e1VGQ8bSxk">pic.twitter.com/e1VGQ8bSxk</a></p>&mdash; Nキチ (@freude111) <a href="https://twitter.com/freude111/status/1547173660586541058?ref_src=twsrc%5Etfw">July 13, 2022</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

ついでにwindowのfetchとOAMメモリの作成まで行う。

### 7/13

spriteの描画処理を大方実装する。

### 7/14

spriteのテストROMはVBlankの割り込み処理の実装を必要としていたため、実装する。  
幾つかの不具合を潰すとspriteのテストROMが動作する。嬉しい。

### 7/15

ここまで来たらコントローラもということでJoyPadを実装し始める。割り込み処理も実装する。

### 7/17

7/16は忙しかったっぽい。JoyPadが動くようになる。もうこれゲームじゃんすげえとか言い始める。

### 7/18

LYCの割り込み処理とか、DMA転送とかを実装する。spriteの色設定にバグがあったので修正する。  
余勢を駆ってTimerまで実装してしまった。TimerのテストROMが通る。割り込み処理のcallに不具合があったのでこれも潰す。

### 7/19

MBC1を実装してCPUのテストROMを通そうと試みる。

知らなかった仕様の罠を踏んだり、前々からバグってるだろうなと確信していた `carry_flag` と `half_carry_flag` が案の定バグっていたりして泣きながら直す。

### 7/20

CPUのテストROMが全て通る。感動。

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">うおーーーーーーー！！！！！<br>ゲームボーイエミュレータのRust実装、CPU命令のテストが全部通った！！！！ <a href="https://t.co/sJgD8TzW2M">pic.twitter.com/sJgD8TzW2M</a></p>&mdash; Nキチ (@freude111) <a href="https://twitter.com/freude111/status/1549706895531065345?ref_src=twsrc%5Etfw">July 20, 2022</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

オーバーフローを起こしていた箇所が複数見つかったため、実際のゲームのROMが動くよう幾つか修正を加える。  
また割り込み処理のcallが壊れていることに気づき(何度目？)、今度こそしっかり直す。

### 7/21

windowとspriteの描画にそれぞれ不具合があることに気づき、修正する。PPUの実装はノリと雰囲気でやったので、案外動くことに驚いた。
ここで参考にしていた先達のエミュレータも同じバグを埋めていることに気づいたので、その内PRを出そうと思う。

### 7/22

画面サイズを可変にしたり、作成録を書いたりする。

### 7/23

MBC5を実装したり、joypadのバグを潰したり。セーブも出来るようにした。  
いよいよサウンドに取り掛かるべく、資料を読み漁る。

### 7/27

ライブラリを選別し、とりあえずレジスタ等の雛形を書く。  
そもそも音声を機械で表現する基礎すら知らなかったので、勉強をし始める。

### 7/28

旅行に行く！w

### 7/30

関東に帰ってくる。

### 7/31

FGOフェスに行く！w

### 8/2

音は並列処理で流すため、それならということでCPUの動作も並列処理に書き直す。  
まだ音声については勉強中。

### 8/5

ひとまず音は出る.....が高音が出てなかったり全体の音量が妙だったりする。ひとまず音声のテストROMを通してバグを潰していくことにする。

### 8/6

最初のテストが通る。

### 8/7

コミットログはないが、二番目のテストが通らず泣いていた記憶がある。

### 8/8

先達の実装を見て、ミックス処理を真似てみると一気にそれっぽい音が出て感動する。基礎知識不足を痛感する。

### 8/11

soundの動作周波数が遅くなっていたことを突き止める(よく今まで音が出てたな)。
一気にsoundのテストを八番目くらいまで通し、ここらでもうええか！w となる。

### 8/12

誕生日！！  
しばらくわちゃわちゃしてPCを触らなくなる。

### 8/14

WASM化してブラウザで動かすことを試みる。調べながら書いたらマジで一生ビルド通らなくてウケる。  
リリースビルドにしたら何か通った。

### 8/15

ビルドが通ったら通ったで `operation not supported on this platform` みたいなことを言われる。キレる。

### 8/16

時間計測やスレッドによる並列処理がブラウザで動かないことが問題だったので、代替手段を調べて実装すると動いた。泣く。  
必要なのはGoogle力ってはっきりわかんだね。

ブラウザ上でキャラクターが動いて音が出るのを眺めていると、何とかここまで来れたなあと感慨深い気持ちになる。

### 8/17

これを書いています。

### 未来

- どうも音が変なので直す
- カラー対応する
- リファクタリングする
- wasm版をもうちょっと拡張する
